<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8"/>
    <title>Chat ROOM of Toni</title>
    <style type="text/css">
    /*TODO: Darle estilo a los mensajes del propio cliente para diferenciarlos*/
      #chat {
        width: 500px;
        overflow-y: scroll;
        height: 200px;
        border: 7px solid black;
      }

      #apodo {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <h1>CHAT ROOM</h1>
    <div id="chat">
      <ul id="messages"></ul>
    </div>
    <form name="enviarmensaje" onsubmit="enviarMsg(msg); return false;">
      <p id="apodo"></p><input type="text" name="msg" id="msg" autocomplete="off"/>
      <input type="submit" value="Enviar"/>
    </form>
  </body>
  <!-- TODO: Separar JS del HTML -->
  <script type="text/javascript">
    // Recibir el apodo
    var id, first, apodo = prompt("Introduce tu apodo");
    console.log("Bienvenido al chat de Toni, "+apodo);
    var inputApodo = document.getElementById('apodo');
    inputApodo.innerHTML = apodo+": ";

    // Obtener el ul chat
    var msgs = document.getElementById('messages');

    // Último mensaje
    var lastMessage = 0;

    // Abrir websocket
    var ws = new WebSocket("ws://localhost:5000/chat")
    ws.onopen = function() {
      ws.send(apodo);
    };

    ws.onclose = function(e){
      console.log("Desconectado - estatus " + this.readyState);
      // TODO: Crear proceso de reconexión
//      console.log("Intentando reconectar...");
    };

      ws.onmessage = getMsg;

    function postMsg(msg) {
      ws.send(msg.value);
      msg.value = "";
    }

    function getMsg(e) {
      if(!first) {
        id = e.data;
        console.log("Mi ID es: "+id);
        first = true;

        return;
      }

      console.log("Mensaje recibido: ")
      console.log(e)
      var msg = e.data;
      if(msg) {
        var li = document.createElement("li");
        li.innerHTML = msg;
        msgs.appendChild(li);
        msgs.lastElementChild.scrollIntoView(true);
      }
    }

    function enviarMsg(msg) {
      console.log(apodo + " envía: " + msg.value)
      postMsg(msg);

      return false;
    }
  </script>
</html>
